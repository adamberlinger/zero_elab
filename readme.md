# Zero eLab

*English description further below*

Zero eLab je projekt který implementuje měřící a výstupní funkce na mikrořadičích
postavených na architektuře ARM Cortex-M (STM32).
Projekt vznikl v rámci diplomové práce v laboratoři videometrie na Katedře měření, FEL ČVUT (https://measure.fel.cvut.cz).
Podobné projekty a výukové materiály v češtině můžete najít zde:  https://embedded.fel.cvut.cz/

## Introduction

Zero eLab is project that implements measurement and "synthesis" functions on general purpose ARM base microcontrollers (STM32 family).
The project was started at the Laboratory of Videometry, Department of Measurement, FEE, CTU in Prague (https://measure.fel.cvut.cz).
Similar interesting projects can be found here (in Czech language): https://embedded.fel.cvut.cz/

This repository contains the firmware for the MCU devices.

Currently implemented functions:
 * Oscilloscope
 * Voltmeter
 * Logic analyzer (experimental)
 * PWM measurement
 * PWM output
 * Generator based on DDS (direct digital synthesis)

The selection of functions depends on selected target. On small devices only the subset of functions is implemented due to peripheral constrains, or limited pinout.

The firmware can also switch between different configurations. E.g. `Voltmeter + PWM`and `Oscilloscope + PWM`.

The firmware communicates with PC application through virtual COM port (USB CDC class) either directly, or by using UART-to-USB bridge.

## How to run the firmware

You can download compiled binaries in the release section and download the via ST-Link (or any other debugger), or via USB device firmware update (DFU).
DFU requires application which can be downloaded here:
 * [STM32CubeProgrammer](https://st.com/stm32cubeprog) (Multiple platforms)
 * [dfu-util](http://dfu-util.sourceforge.net/) (GNU/Linux)
 * [DfuSe](http://www.st.com/content/st_com/en/products/development-tools/software-development-tools/stm32-software-development-tools/stm32-programmers/stsw-stm32080.html) (Windows)

Currently it is recommended to use STM32CubeProgrammer, since DfuSe application is deprecated. For DfuSe the generated `*.dfu` files can be used. STM32CubeProgrammer works with HEX or BIN files.

dfu-util can be invoked like this from the command line:
```
dfu-util -a 0 -D <path to dfu file>
```

dfu-util also enables to load directly the `*.bin` files.

## PC application

The PC application written in QT can be found in separate [repository](https://github.com/adamberlinger/zero_elabviewer/).

## Supported devices

Currently there are several main targets supported:
 * STM32F042F6 baremetal TSSOP20 package
 * STM32F042K6 baremetal LQFP32 package
 * STM32G031J6 baremetal SO-8 package
 * STM32F103C8 "bluepill" board

There are other targets defined in code, but they might not be maintained / tested properly.

The great advantage of the STM32F042 devices is a minimum of external components, that are required to make it work. Basically only decoupling capacitors, voltage regulator and USB connector are required.

For STM32F103C8 "bluepill" board, you can use [USB DFU bootloader](https://github.com/adamberlinger/stm32f103_bluepill_dfu) for easy firmware update.

[//]: # (Replace this section in future with link to wiki)

## Limitations

To be done.

## How to build

The build requires `arm-none-eabi-gcc` compiler, Make and basic shell. It should be possible to compile on both Linux and Windows machines. On Windows I used mingw.

First we need to run configuration script and select target we want to compile
```
./build.sh scan
./build.sh configure
```

Then we run the Make (to generate ELF file):
```
make
```

Or we can generate HEX, BIN or DFU files:
```
make bin
make hex
make dfu
```

It is also possible to generate all files for different target running:
```
./build.sh build_all
```

Finally we can compile specific target without prior configuration using TARGET_NAME parameter:
```
make TARGET_NAME=stm32f042f6 hex
```

## How to debug

Most comfortable way to debug is to use [STM32CubeIDE](https://st.com/stm32cubeide). To debug external ELF file, you can create dummy project, selecting the right MCU part number (to have good view of the internal registers). In Debug configuration use the external ELF file (generated by Makefile in this project.

Other way is to use GDB from command line. In one terminal we run OpenOCD / GDB server:
```
make server
```

In other terminal we run the debugger (it connects automatically to the server):
```
make debug
```

## GNU/Linux USB issues

There is dedicated file describing some possible issues: [linux-usb-note.md](/linux-usb-note.md)

## Contributing

Anyone is welcomed to provide feedback or contribute to the projects. Some parts of the code are not well written and require refactoring which will have to be done probably by the author. Also currently there are no clear coding standards defined.

Anyway if you find some bug, or have some idea for improving the application, you can submit an issue on github.

## License and 3rd party code

Firmware itself is license under BSD 3-Clause License

Firmware also relies on register definitions which are part CMSIS libraries. These files either license under BSD 3-Clause License (old versions) or Apache-2.0 (new versions). Each file has the license mentioned in header.

To generate DFU file (used by old DfuSe Demo tool), python script (tools/dfu.py) by Antonio Galea is used, which is license under LGPL 3.0.
